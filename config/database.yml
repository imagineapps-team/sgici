# PostgreSQL Multi-tenant Configuration
#
# Este projeto suporta dois modos:
#
# 1. MULTI-TENANT (EcoEnel): usa shards para múltiplas regionais
#    - Configurar: MULTI_TENANT_ENABLED=true
#    - Shards: ecoenel_sp, ecoenel_ce
#
# 2. SINGLE-TENANT (Light): usa apenas o banco primary
#    - Configurar: MULTI_TENANT_ENABLED=false (ou não definir)
#
# O tenant é selecionado no login e armazenado na sessão.
# O middleware TenantSwitchable troca a conexão automaticamente.

default: &default
  adapter: postgresql
  encoding: unicode
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
  host: <%= ENV.fetch("DATABASE_HOST", "localhost") %>
  username: <%= ENV.fetch("DATABASE_USERNAME", "postgres") %>
  password: <%= ENV.fetch("DATABASE_PASSWORD", "") %>

development:
  primary:
    <<: *default
    database: <%= ENV.fetch("DATABASE_NAME", "ecoenel") %>
<% if ENV["MULTI_TENANT_ENABLED"] == "true" %>
  ecoenel_sp:
    <<: *default
    database: <%= ENV.fetch("DATABASE_NAME_SP", "ecoenel") %>
  ecoenel_ce:
    <<: *default
    database: <%= ENV.fetch("DATABASE_NAME_CE", "ecoenel_ce") %>
<% end %>

test:
  primary:
    <<: *default
    database: avsi_test
<% if ENV["MULTI_TENANT_ENABLED"] == "true" %>
  ecoenel_sp:
    <<: *default
    database: avsi_ecoenel_sp_test
  ecoenel_ce:
    <<: *default
    database: avsi_ecoenel_ce_test
<% end %>

production:
  primary: &primary_production
    <<: *default
    host: <%= ENV.fetch("DATABASE_HOST", "localhost") %>
    username: <%= ENV.fetch("DATABASE_USERNAME", "postgres") %>
    password: <%= ENV.fetch("DATABASE_PASSWORD", "") %>
    database: <%= ENV.fetch("DATABASE_NAME_SP", ENV.fetch("DATABASE_NAME", "ecoenel")) %>
<% if ENV["MULTI_TENANT_ENABLED"] == "true" %>
  ecoenel_sp:
    <<: *default
    host: <%= ENV.fetch("DATABASE_HOST", "localhost") %>
    username: <%= ENV.fetch("DATABASE_USERNAME", "postgres") %>
    password: <%= ENV.fetch("DATABASE_PASSWORD", "") %>
    database: <%= ENV.fetch("DATABASE_NAME_SP", "ecoenel") %>
  ecoenel_ce:
    <<: *default
    host: <%= ENV.fetch("DATABASE_HOST", "localhost") %>
    username: <%= ENV.fetch("DATABASE_USERNAME", "postgres") %>
    password: <%= ENV.fetch("DATABASE_PASSWORD", "") %>
    database: <%= ENV.fetch("DATABASE_NAME_CE", "ecoenel_ce") %>
<% end %>
  # Solid gems compartilham o banco primário (tabelas separadas)
  cache:
    <<: *primary_production
    migrations_paths: db/cache_migrate
  queue:
    <<: *primary_production
    migrations_paths: db/queue_migrate
  cable:
    <<: *primary_production
    migrations_paths: db/cable_migrate
